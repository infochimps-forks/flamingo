#!/usr/bin/env ruby
require 'rubygems'
gem 'redis-namespace','0.7.0'

$LOAD_PATH.unshift File.expand_path(File.dirname(__FILE__) + '/../lib')
require 'flamingo'
require 'optparse'
require 'wukong'
require 'wukong/store'

#require 'rubygems'
#require 'graphiterb'

# This is a stub definition for the TwitterScrapeJob class which identifies which queue
# to put data on. Later, workers will instantiate this class as it is defined
# by 'wuclan/twitter/scrape_job/twitter_scrape_job'
class TwitterStreamScrapeJob
 @queue = "twitter_stream"
end

module Flamingo
  class Wader
    private
    def dispatch_event event_json
      Flamingo.logger.debug "Wader dispatched event -- monkeypatched"

      #TODO: add graphite performance data back in here. 

      #flamingo_counter.increment("events")
      #flamingo_counter.incrementBy(event_json.length,"bytes")

      commitlog << event_json
      Resque.enqueue( TwitterStreamScrapeJob, event_json)
    end

    def commitlog
      return @commitlog if @commitlog
      @commitlog = Wukong::Store::ChhChunkedFlatFileStore.new( { :rootdir => File.expand_path(Flamingo.config.commitlog_path), :chunktime => Flamingo.config.commitlog_chunk_time , :filemode => 'a+'} )
      EventMachine.add_periodic_timer(Flamingo.config.commitlog_chunk_time){ @commitlog.new_chunk }
      @commitlog
    end
  end
end

load File.dirname(__FILE__) + '/flamingod'
